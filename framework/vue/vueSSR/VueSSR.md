# 背景

Vue/React/Angular都是基于客户端渲染的框架，打包后生成的结果都是一个单页面应用

SPA(Single Page Application)单页面应用的优点：

- 用户体验好
- 开发效率高
- 渲染性能好
- 可维护性好

缺点：

- 首屏渲染事件过长
- 不利于SEO（搜索引擎爬取HTML时，单页应用的HTML这时候还没有内容）

基于以上的情况，业界提出了**同构应用**的解决方案：

- 通过服务端渲染首屏直出，解决SPA应用首屏渲染慢以及不利于SEO的问题
- 通过客户端渲染接管页面内容交互，得到更好的体验

通过这种方式构建的应用称为服务端渲染应用，或同构应用

# 概念

渲染：将**数据**和**模板**拼接到一起

## 传统的服务端渲染

早期的渲染都是在服务端进行的

![image-20210202092546173](.\images\传统服务端渲染.png)

步骤：

1. 获取页面模板
2. 获取数据
3. 渲染：数据结合模板
4. 返回渲染结果给客户端

传统服务端渲染的缺点：

- 前后端代码完全耦合，不利于开发和维护
- 前端没有足够的发挥空间
- 服务端压力大
- 用户体验一般

## 客户端渲染

随着客户端Ajax技术的普及，使得客户端可以动态获取数据，从而实现客户端渲染

![image-20210202095825712](.\images\客户端渲染.png)

客户端渲染的缺点：

**首屏渲染慢**

传统的服务端渲染是页面直出，只需要一次HTTP请求

而客户端渲染，至少需要三次请求，页面、JS脚本、以及ajax动态数据请求

**不利于SEO**

搜索引擎获取的网页并没有实质内容，需要通过脚本的执行来发起请求并获取数据

## 同构渲染

基于React、Vue等框架，是客户端渲染和服务端渲染的结合

- 在服务端执行一次，用户实现服务器端的渲染（首屏直出）
- 在客户端再执行一次，用于接管页面交互

核心解决了SEO和首屏渲染慢的问题

![image-20210202103101400](.\images\同构渲染.png)

同构渲染方案：

- React、Vue官方解决方案，好理解，但比较麻烦
- 第三方解决方案，如Next.js(基于React)，Nuxt.js(基于Vue)

同构渲染的问题：

- 开发条件有限

  - 浏览器特定的代码只能在某些生命周期钩子函数中使用
  - 一些外部扩展库可能需要特殊处理才能在服务端渲染应用中使用
  - 不能在服务端渲染期间操作DOM
  - 某些代码操作需要区分运行环境

- 涉及构建和部署的要求更多

  |      | 客户端渲染                | 同构渲染                   |
  | ---- | ------------------------- | -------------------------- |
  | 构建 | 仅构建客户端应用          | 需要构建两个端             |
  | 部署 | 可以部署在任意web服务器中 | 只能部署在Node.js Server上 |

- 更多的服务端负载

  - 在Node中渲染完整的应用程序，相比仅提供静态文件的服务器，需要占用大量的CPU资源
  - 如果应用在高流量环境下，需要准备相应的服务器负载
  - 需要更多的服务端渲染优化工作处理

什么时候要使用服务端渲染：

- 首屏渲染速度是否真的重要
- **是否真的需求SEO**

# Nuxt

一个基于Vue生态的第三方开源服务端渲染应用框架

路由，视图部分见nuxt-demo

asyncData方法：Nuxt扩展了Vue，使用asyncData 方法来接收异步操作的返回结果

用法：

- 会将asyncData返回的数据融合组件的data方法返回的数据，一并给到组件
- 在服务端渲染期间和客户端更新路由期间调用

注意：

- 只能在页面组件中使用，不能再普通组件中使用
- 没有this，因为是在组件初始化之前被调用的

可以使用上下文对象来在使用asyncData时获取一些例如Vue实例的初始化参数

CI/CD 服务

持续集成，自动化部署

原理如图

![image-20210210112337731](.\images\CI.png)

使用Github Actions来实现CI/CD

1. 代码发布到GitHub
2. 在GitHub中，用户--settings--Developer settings--Personal access tokens生成token
3. 将token保存到项目--settings--secrets，新建一个secret，注意名称和token名称一致
4. 配置GitHub actions执行脚本
   1. 在项目根目录创建.github/workflows目录
   2. 下载main.yml到workflows目录中
   3. 修改配置
   4. 配置PM2配置文件
   5. 提交更新
      1. 先提交代码
      2. 新建tag  `git tag v1.0.0`
      3. 推送代码到这个tag  `git push origin v1.0.0`
   6. 查看自动部署状态
   7. 访问网站